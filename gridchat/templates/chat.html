<html>
    <head>
        <title>Grid Notify v{{ version }}</title>
        <link rel="stylesheet" href="css/base-min.css">
        <link rel="stylesheet" href="css/pure-min.css">
        <link rel="stylesheet" href="css/grids-responsive-min.css">
        <link rel="stylesheet" href="css/main.css">

        <script type="text/javascript" src="js/jquery-3.1.1.min.js"></script>
        <script type="text/javascript" src="js/socket.io-1.4.5.js"></script>
        <script type="text/javascript" src="js/localstoragedb.min.js"></script>
        <script type="text/javascript">
            var lib = new localStorageDB('msgs', localStorage);
            if (lib.isNew()) {
                lib.createTable('messages', ['uuid', 'timestamp', 'user', 'room', 'msg']);
                lib.commit();
            }

            add_to_chat = function(msg) {
                $('#chat').html($('#chat').html() + msg);
                $('#chat').scrollTop($('#chat')[0].scrollHeight);
                //$('#chat').scrollTop = $('#chat').scrollHeight;
            };

            show_history_for = function(room_id) {
                msg_history = lib.queryAll('messages', {
                    query: {room: room_id},
                    sort: [['timestamp', 'asc']]
                });

                for (i = 0; i < msg_history.length; i++) {
                    add_to_chat(msg_history[i].timestamp + ' <' + msg_history[i].user + '> ' + msg_history[i].msg + '\n');
                }
            };

            on_room_click = function() {
                $('a.room').click(function() {
                    room_id = $(this).attr('id').split('room-id-', 2)[1]
                    $('#chat').html('');
                    $('#target').val($(this).text());
                    $('#room-id').val(room_id);
                    $('#private').attr('checked', false);
                    socket.emit('join', {
                        actor: {
                            id: '{{ user_id }}',
                            summary: '{{ user_name }}'
                        },
                        verb: 'join',
                        target: {
                            id: room_id
                        }
                    });
                });
            };

            on_user_click = function() {
                $('a.user').click(function() {
                    room_id = $(this).attr('id').split('-', 2)[1];
                    $('#target').val($(this).text());
                    $('#private').attr('checked', true);
                    $('#room-id').val(room_id)
                    $('#current-room').html($('#target').val());
                    $('#chat').html('');
                    add_to_chat('<< chatting with ' + $(this).text() + ' >>\n');
                    show_history_for(room_id);
                });
            };

            var socket;
            $(document).ready(function(){
                socket = io.connect('http://' + document.domain + ':' + location.port + '/chat');

                socket.on('connect', function() {
                    socket.emit('login', {
                        verb: 'login',
                        actor: {
                            id: '{{ user_id }}',
                            summary: '{{ user_name }}',
                            attachments: [
                                {
                                    objectType: 'gender',
                                    content: '{{ gender }}'
                                },
                                {
                                    objectType: 'age',
                                    content: '{{ age }}'
                                },
                                {
                                    objectType: 'membership',
                                    content: '{{ membership }}'
                                },
                                {
                                    objectType: 'fake_checked',
                                    content: '{{ fake_checked }}'
                                },
                                {
                                    objectType: 'has_webcam',
                                    content: '{{ has_webcam }}'
                                },
                                {
                                    objectType: 'country',
                                    content: '{{ country }}'
                                },
                                {
                                    objectType: 'city',
                                    content: '{{ city }}'
                                },
                                {
                                    objectType: 'token',
                                    content: '66968fad-2336-40c9-bc6d-0ecbcd91f4da'
                                }
                            ]
                        }
                    });
                });

                socket.on('gn_connect', function(data) {
                    socket.emit('list_rooms', {
                        actor: {
                            id: '{{ user_id }}',
                            summary: '{{ user_name }}'
                        },
                        verb: 'list'
                    });
                });

                socket.on('gn_status', function(response) {
                    add_to_chat('<< ' + response.data + ' >>\n');
                });

                socket.on('gn_join', function(response) {
                    console.log(response);
                    if (response.status_code != 200) {
                        add_to_chat('<< not allowed to join room ' + $('#target').val() + ' >>\n');
                        return;
                    }

                    $('#current-room').html($('#target').val());
                    socket.emit('users_in_room', {
                        actor: {
                            id: '{{ user_id }}'
                        },
                        verb: 'list',
                        target: {
                            id: $('#room-id').val()
                        }
                    });

                    socket.emit('history', {
                        actor: {
                            id: '{{ user_id }}'
                        },
                        verb: 'history',
                        target: {
                            id: $('#room-id').val()
                        }
                    });

                    socket.emit('get_acl', {
                        actor: {
                            id: '{{ user_id }}'
                        },
                        verb: 'get',
                        target: {
                            id: $('#room-id').val()
                        }
                    });
                });

                socket.on('gn_history', function(response) {
                    console.log(response);
                    data = response.data;
                    msgs = data.object.attachments;

                    for (i = 0; i < msgs.length; i++) {
                        msg = msgs[i];
                        lib.insertOrUpdate('messages', {uuid: msg.id}, {
                            uuid: msg.id,
                            user: msg.summary,
                            room: data.target.id,
                            msg: msg.content,
                            timestamp: msg.published
                        });
                    }

                    lib.commit();
                    show_history_for(data.target.id);
                });

                socket.on('gn_list_rooms', function(response) {
                    console.log(response);

                    rooms = response.data.object.attachments

                    $('#rooms').html('');
                    for (i = 0; i < rooms.length; i++) {
                        room_name = rooms[i].content
                        room_id = rooms[i].id
                        $('#rooms').html('<a href="#" id="room-id-' + room_id + '" class="room">' + room_name + '</a>' + ' ' + $('#rooms').html());
                    }
                    on_room_click();
                });

                socket.on('gn_users_in_room', function(response) {
                    console.log(response);
                    users = response.data.object.attachments;

                    $('#users_in_room').html('');
                    if (users == null || users.length == 0) {
                        add_to_chat('<< new room created >>\n');
                        return;
                    }

                    for (i = 0; i < users.length; i++) {
                        user_id = users[i].id;
                        user_name = users[i].content

                        if ($('#user-' + user_id).length > 0) {
                            continue;
                        }

                        $('#users_in_room').html('<a href="#" id="user-' + user_id + '" class="user">' + user_name + '</a>' + ' ' + $('#users_in_room').html());
                    }
                    on_user_click();
                });

                socket.on('gn_user_connected', function(data) {
                    console.log(data);
                    if ($('a#online-user-' + data.actor.id).length > 0) {
                        return;
                    }

                    $('#online').html($('#online').html() + '<a href="#" id="online-user-' + data.actor.id + '">' + data.actor.summary + '</a> ');
                    $('a#online-user-' + data.actor.id).click(function() {
                        $('#target').val($(this).text());
                        $('#private').attr('checked', true);
                        $('#room-id').val($(this).attr('id').split('-', 2)[1])
                        $('#current-room').html($('#target').val());
                        add_to_chat('<< chatting with ' + data.actor.summary + ' >>\n')
                        show_history_for(data.actor.id);
                    });
                });

                socket.on('gn_user_disconnected', function(data) {
                    console.log(data);
                    $('a#online-user-' + data.actor.id).remove();
                    $('a#user-' + data.actor.id).remove();
                    add_to_chat('<< ' + data.actor.summary + ' has disconnected >>\n');
                });

                socket.on('gn_room_created', function(data) {
                    console.log(data);
                    $('#rooms').html('<a href="#" id="room-id-' + data.target.id + '" class="room">' + data.target.displayName + '</a>' + ' ' + $('#rooms').html());
                    on_room_click();
                });

                socket.on('gn_user_left', function(data) {
                    console.log(data);
                    $('a#user-' + data.actor.id).remove();
                    add_to_chat('<< ' + data.actor.summary + ' has left room ' + data.target.displayName + ' >>\n');
                });

                socket.on('gn_user_joined', function(data) {
                    console.log(data);

                    if ($('#user-' + data.actor.id).length > 0) {
                        return;
                    }

                    add_to_chat('<< ' + data.actor.summary + ' has joined room ' + data.target.displayName + ' >>\n');
                    $('#users_in_room').html($('#users_in_room').html() + ' <a href="#" id="user-' + data.actor.id + '" class="user">' + data.actor.summary + '</a>');

                    $('a#user-' + data.actor.id).click(function() {
                        $('#target').val(data.actor.summary);
                        $('#private').attr('checked', true);
                        $('#room-id').val($(this).attr('id').split('-', 2)[1])
                        $('#current-room').html($('#target').val());
                        add_to_chat('<< chatting with ' + data.actor.summary + ' >>\n')
                        show_history_for(data.actor.id);
                    });
                });

                handle_message = function(data) {
                    if ($('#room-id').val() == data.target.id || $('#room-id').val() == data.actor.id) {
                        add_to_chat(data.published + ' <' + data.actor.summary + '> ' + data.object.content + '\n');
                    }
                    room_id = data.target.id
                    if ('{{ user_id }}' === data.target.id) {
                        room_id = data.actor.id;
                    }

                    lib.insertOrUpdate('messages', {uuid: data.id}, {
                        uuid: data.id,
                        user: data.actor.summary,
                        room: room_id,
                        msg: data.object.content,
                        timestamp: data.published
                    });
                    lib.commit();
                };

                socket.on('gn_message', function(response) {
                    console.log(response);
                    data = response.data
                    handle_message(data);
                });

                socket.on('message', function(data) {
                    console.log(data);
                    if (data.actor.id == '{{ user_id }}') {
                        return;
                    }
                    handle_message(data);
                });

                socket.on('gn_create', function(response) {
                    console.log(response);
                    if (response.status_code == 200) {
                        $('#new-room-name').val('');
                    }
                });

                socket.on('gn_set_acl', function(response) {
                    console.log(response);
                });

                socket.on('gn_get_acl', function(response) {
                    data = response.data
                    $('#acl-in-room').html('');
                    for (i = 0; i < data.object.attachments.length; i++) {
                        acl = data.object.attachments[i];
                        $('#acl-in-room').html(acl.objectType + '=' + acl.content + ' ' + $('#acl-in-room').html());
                    }
                    console.log(response);
                });

                $('#text').keypress(function(e) {
                    var code = e.keyCode || e.which;
                    if (code == 13) {
                        text = $('#text').val();
                        room_name = $('#target').val();
                        room_id = $('#room-id').val();
                        $('#text').val('');

                        target_type = 'group';
                        if ($('#private').attr('checked')) {
                            target_type = 'private';
                        }

                        socket.emit('message', {
                            actor: {
                                id: '{{ user_id }}',
                                summary: '{{ user_name }}'
                            },
                            verb: 'send',
                            target: {
                                id: room_id,
                                displayName: room_name
                            },
                            object: {
                                content: text,
                                objectType: target_type
                            }
                        });
                    }
                });

                $('input#create-the-room').click(function() {
                    socket.emit('create', {
                        actor: {
                            id: '{{ user_id }}',
                            summary: '{{ user_name }}'
                        },
                        verb: 'create',
                        target: {
                            displayName: $('#new-room-name').val()
                        }
                    });
                });

                $('a#leave').click(function() {
                    socket.emit('leave', {
                        actor: {
                            id: '{{ user_id }}',
                            summary: '{{ user_name }}'
                        },
                        verb: 'leave',
                        target: {
                            id: $('#room-id').val()
                        }
                    });
                    $('#current-room').html('');
                    $('#users_in_room').html('');
                    $('#chat').html('');
                    $('#target').val('');
                });

                $('#update-acl').click(function()  {
                    genders = $('#genders').val();
                    memberships = $('#memberships').val();
                    webcam = $('#webcam').is(':checked');
                    image = $('#image').is(':checked');
                    fake = $('#fake').is(':checked');
                    age_min = $('#age-min').val();
                    age_max = $('#age-max').val();
                    country = $('#country').val();
                    city = $('#city').val();

                    webcam = webcam ? 'y': '';
                    image = image ? 'y': '';
                    fake = fake ? 'y': '';

                    age = ':'
                    if (age_min != '') {
                        age = age_min + ':';
                    }
                    if (age_max != '') {
                        age += age_max;
                    }
                    if (age == ':') {
                        age = '';
                    }

                    socket.emit('set_acl', {
                        actor: {
                            id: '{{ user_id }}'
                        },
                        verb: 'set',
                        object: {
                            objectType: 'acl',
                            attachments: [
                                {
                                    objectType: 'gender',
                                    content: genders
                                },
                                {
                                    objectType: 'membership',
                                    content: memberships
                                },
                                {
                                    objectType: 'has_webcam',
                                    content: webcam
                                },
                                {
                                    objectType: 'image',
                                    content: image
                                },
                                {
                                    objectType: 'fake_checked',
                                    content: fake
                                },
                                {
                                    objectType: 'age',
                                    content: age
                                },
                                {
                                    objectType: 'country',
                                    content: country
                                },
                                {
                                    objectType: 'city',
                                    content: city
                                }
                            ]
                        },
                        target: {
                            id: $('#room-id').val()
                        }
                    });
                });
            });
        </script>
    </head>
    <body>
        <h1>Grid Notify <small>v{{ version }}</small></h1>
        User name: <b>{{ user_name }}</b>, gender: <b>{{ gender }}</b>, membership: <b>{{ membership }}</b>, age: <b>{{ age }}</b>, faked checked: <b>{{ fake_checked }}</b>,
        image: <b>{{ image }}</b>, has webcam: <b>{{ has_webcam }}</b>, country: <b>{{ country }}</b>, city: <b>{{ city }}</b><br />
        Current room: <span id="current-room" style="font-weight: bold;">none</span>,
        Owner(s) of room: <span id="current-owners" style="font-weight: bold;">none</span><br />

        <div class="pure-g">
            <div class="pure-u-1 pure-u-md-1-2">
                <div class="l-box">
                    <textarea id="chat" class="pure-u-1" style="height: 400px;" readonly></textarea>
                    <input id="text" class="pure-u-1" placeholder="Enter your message here and press enter to send" />
                </div>
            </div>
            <div class="pure-u-1 pure-u-md-1-2">
                <div class="l-box">
                    <div>
                        ACL for this room: <span id="acl-in-room" style="font-weight: bold;"></span>
                    </div>
                    <form class="pure-form pure-form-aligned">
                        <fieldset>
                            <div class="pure-control-group">
                                <label for="genders">Genders</label>
                                <input id="genders" type="text" placeholder="e.g. m,f,ts">
                            </div>

                            <div class="pure-control-group">
                                <label for="memberships">Memberships</label>
                                <input id="memberships" type="text" placeholder="e.g. 0,1,4">
                            </div>

                            <div class="pure-control-group">
                                <label for="age-min">Min age</label>
                                <input id="age-min" type="text" placeholder="e.g. 25">
                            </div>

                            <div class="pure-control-group">
                                <label for="age-max">Max age</label>
                                <input id="age-max" type="text" placeholder="e.g. 35">
                            </div>

                            <div class="pure-control-group">
                                <label for="country">Country</label>
                                <input id="country" type="text" placeholder="e.g. cn,de,dk">
                            </div>

                            <div class="pure-control-group">
                                <label for="city">City</label>
                                <input id="city" type="text" placeholder="e.g. Berlin,Shanghai">
                            </div>

                            <div class="pure-control-group">
                                <label for="webcam" class="pure-checkbox">Needs webcam?</label>
                                <input id="webcam" type="checkbox" value="">
                            </div>

                            <div class="pure-control-group">
                                <label for="image" class="pure-checkbox">Needs image?</label>
                                <input id="image" type="checkbox" value="">
                            </div>

                            <div class="pure-control-group">
                                <label for="fake" class="pure-checkbox">Needs to be fake checked?</label>
                                <input id="fake" type="checkbox" value="">
                            </div>

                        </fieldset>
                    </form>

                    <button type="submit" id="update-acl" class="pure-button pure-input-1-2 pure-button-primary">Update ACL</button>
                </div>
            </div>
        </div>

        <input id="target" type="hidden" />
        <input id="room-id" type="hidden" />
        <input id="private" type="checkbox" hidden />
        <br /><br />

        Users in current room: <span id="users_in_room"></span><br />
        All rooms: <span id="rooms"></span><br /><br />

        <a id="leave" href="#">Leave this room</a><br /><br /><br />

        Create new room: <input id="new-room-name" />
        <input type="button" id="create-the-room" value="Create" />
    </body>
</html>